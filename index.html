<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BALL x PIT è¿›åŒ–å›¾é‰´</title>
  <meta name="description" content="Ball x Pit å®Œæ•´è¿›åŒ–å›¾é‰´ - çŸ©é˜µ/åˆ—è¡¨/å›¾é‰´ä¸‰ç§è§†å›¾">
  
  <style>
    /* ========== CSS å˜é‡ ========== */
    :root {
      --bg-primary: #0a0e14;
      --bg-secondary: #141b22;
      --bg-tertiary: #1a2332;
      --bg-hover: #243044;
      --border-color: #2a3a4a;
      --text-primary: #e6edf3;
      --text-secondary: #8b949e;
      --text-muted: #6e7681;
      --accent-primary: #58a6ff;
      --accent-secondary: #3fb950;
      --accent-warning: #d29922;
      --accent-danger: #f85149;
      --accent-purple: #a371f7;
      --accent-pink: #db61a2;
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.4);
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --transition-fast: 0.15s ease;
      --transition-normal: 0.25s ease;
    }

    /* ========== åŸºç¡€æ ·å¼ ========== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      overflow-x: hidden;
      width: 100%;
    }

    body {
      font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
      overflow-x: hidden;
      width: 100%;
      position: relative;
    }

    /* ========== å¤´éƒ¨ ========== */
    .header {
      background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
      padding: 24px 20px;
      text-align: center;
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
      letter-spacing: 2px;
    }

    .header p {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .lang-switch {
      padding: 8px 16px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-purple));
      border: none;
      border-radius: var(--radius-md);
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition-fast);
      white-space: nowrap;
      flex-shrink: 0;
    }

    .lang-switch:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(88, 166, 255, 0.4);
    }

    /* ========== æ§åˆ¶æ  ========== */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      align-items: center;
      padding: 16px 20px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
    }

    .search-box {
      position: relative;
      flex: 1;
      max-width: 320px;
      min-width: 0;
    }

    .search-box input {
      width: 100%;
      padding: 10px 16px 10px 40px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 14px;
      transition: var(--transition-fast);
    }

    .search-box input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.15);
    }

    .search-box::before {
      content: "ğŸ”";
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      opacity: 0.6;
    }

    .view-tabs {
      display: flex;
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      padding: 4px;
      gap: 4px;
    }

    .view-tab {
      padding: 8px 16px;
      background: transparent;
      border: none;
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition-fast);
      font-weight: 500;
    }

    .view-tab:hover {
      color: var(--text-primary);
      background: var(--bg-hover);
    }

    .view-tab.active {
      background: var(--accent-primary);
      color: white;
    }

    /* ========== ä¸»å†…å®¹åŒº ========== */
    .main-content {
      padding: 20px;
      max-width: 1600px;
      margin: 0 auto;
    }

    .view-container {
      display: none;
    }

    .view-container.active {
      display: block;
    }

    /* ========== çŸ©é˜µè§†å›¾ ========== */
    .matrix-wrapper {
      overflow-x: auto;
      padding-bottom: 20px;
    }

    .matrix-table {
      border-collapse: collapse;
      margin: 0 auto;
      border: 2px solid #4a5a6a;
    }

    .matrix-table th,
    .matrix-table td {
      width: 60px;
      height: 60px;
      text-align: center;
      vertical-align: middle;
      font-size: 10px;
      position: relative;
      border: 1px solid #2a3a4a;
    }

    .matrix-table th {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      font-weight: 600;
      padding: 4px;
      border: 1px solid #3a4a5a;
    }

    /* ç¬¬ä¸€è¡Œå’Œç¬¬ä¸€åˆ—çš„è¡¨å¤´åŠ ç²—è¾¹æ¡† */
    .matrix-table tr:first-child th {
      border-bottom: 2px solid #5a6a7a;
    }

    .matrix-table th:first-child {
      border-right: 2px solid #5a6a7a;
    }

    /* æ¯5è¡Œ/åˆ—æ·»åŠ åˆ†éš”çº¿ä¾¿äºé˜…è¯» */
    .matrix-table tr:nth-child(6) td,
    .matrix-table tr:nth-child(6) th,
    .matrix-table tr:nth-child(11) td,
    .matrix-table tr:nth-child(11) th,
    .matrix-table tr:nth-child(16) td,
    .matrix-table tr:nth-child(16) th {
      border-top: 2px solid #3d4d5d;
    }

    .matrix-table td:nth-child(6),
    .matrix-table th:nth-child(6),
    .matrix-table td:nth-child(11),
    .matrix-table th:nth-child(11),
    .matrix-table td:nth-child(16),
    .matrix-table th:nth-child(16) {
      border-left: 2px solid #3d4d5d;
    }

    .matrix-table th img {
      width: 32px;
      height: 32px;
      object-fit: contain;
      display: block;
      margin: 0 auto 2px;
      border-radius: 4px;
    }

    .matrix-table th span {
      display: block;
      font-size: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .matrix-cell {
      background: var(--bg-secondary);
      cursor: pointer;
      transition: var(--transition-fast);
      padding: 4px;
    }

    .matrix-cell:hover {
      background: var(--bg-hover);
      box-shadow: inset 0 0 0 2px var(--accent-primary);
      z-index: 10;
    }

    .matrix-cell.empty {
      background: var(--bg-primary);
      cursor: default;
    }

    .matrix-cell.empty:hover {
      box-shadow: none;
    }

    .matrix-cell img {
      width: 36px;
      height: 36px;
      object-fit: contain;
      display: block;
      margin: 0 auto;
      border-radius: 4px;
    }

    .matrix-cell .cell-name {
      font-size: 8px;
      color: var(--text-secondary);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .matrix-cell.highlight {
      box-shadow: 0 0 0 2px var(--accent-primary);
    }

    /* ========== åˆ—è¡¨è§†å›¾ ========== */
    .list-view {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .list-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      overflow: hidden;
      transition: var(--transition-normal);
    }

    .list-card:hover {
      border-color: var(--accent-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .list-card-header {
      background: var(--bg-tertiary);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .list-card-header img {
      width: 40px;
      height: 40px;
      object-fit: contain;
      border-radius: 6px;
    }

    .list-card-header h3 {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .list-card-header .subtitle {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .list-card-body {
      padding: 12px 16px;
    }

    .combo-item {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .combo-item:last-child {
      border-bottom: none;
    }

    .combo-item:hover {
      background: var(--bg-hover);
      margin: 0 -16px;
      padding: 8px 16px;
    }

    .combo-item img {
      width: 28px;
      height: 28px;
      object-fit: contain;
      margin-right: 10px;
      border-radius: 4px;
    }

    .combo-item .combo-text {
      flex: 1;
      font-size: 13px;
    }

    .combo-item .partner {
      color: var(--text-secondary);
    }

    .combo-item .arrow {
      color: var(--accent-primary);
      margin: 0 8px;
    }

    .combo-item .result {
      color: var(--accent-secondary);
      font-weight: 500;
    }

    /* ========== å›¾é‰´è§†å›¾ ========== */
    .gallery-section {
      margin-bottom: 32px;
    }

    .gallery-section:last-child {
      margin-bottom: 0;
    }

    .gallery-section-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--accent-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .gallery-section-title::before {
      content: "";
      width: 4px;
      height: 18px;
      background: var(--accent-primary);
      border-radius: 2px;
    }

    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
    }

    .gallery-item {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition-normal);
    }

    .gallery-item:hover {
      border-color: var(--accent-primary);
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .gallery-item img {
      width: 64px;
      height: 64px;
      object-fit: contain;
      margin-bottom: 8px;
      border-radius: 8px;
    }

    .gallery-item .item-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .gallery-item .item-name-cn {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .gallery-item .item-tier {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      margin-top: 6px;
    }

    .tier-basic {
      background: rgba(88, 166, 255, 0.2);
      color: var(--accent-primary);
    }

    .tier-evolved {
      background: rgba(63, 185, 80, 0.2);
      color: var(--accent-secondary);
    }

    .tier-advanced {
      background: rgba(163, 113, 247, 0.2);
      color: var(--accent-purple);
    }

    .tier-passive {
      background: rgba(210, 153, 34, 0.2);
      color: var(--accent-warning);
    }

    /* ========== ç­–ç•¥è§†å›¾ ========== */
    .strategy-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
      padding: 16px;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
    }

    .strategy-filter-btn {
      padding: 8px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .strategy-filter-btn:hover {
      border-color: var(--accent-primary);
      color: var(--text-primary);
    }

    .strategy-filter-btn.active {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: white;
    }

    .strategy-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
      gap: 20px;
    }

    .strategy-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      overflow: hidden;
      transition: var(--transition-normal);
    }

    .strategy-card:hover {
      border-color: var(--accent-primary);
      box-shadow: var(--shadow-lg);
    }

    .strategy-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
    }

    .strategy-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .strategy-type-badge {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .strategy-name {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .strategy-name-cn {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .strategy-meta {
      text-align: right;
    }

    .strategy-difficulty,
    .strategy-rating {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .strategy-stars {
      color: #f1c40f;
      letter-spacing: -2px;
    }

    .strategy-body {
      padding: 20px;
    }

    .strategy-desc {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 16px;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      border-left: 3px solid var(--accent-primary);
    }

    .strategy-balls-section {
      margin-bottom: 16px;
    }

    .strategy-balls-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }

    .strategy-balls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .strategy-ball {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .strategy-ball:hover {
      border-color: var(--accent-primary);
      background: var(--bg-hover);
    }

    .strategy-ball.core {
      border-color: var(--accent-danger);
      background: rgba(248, 81, 73, 0.1);
    }

    .strategy-ball img {
      width: 28px;
      height: 28px;
      border-radius: 4px;
    }

    .strategy-ball-name {
      font-size: 12px;
      color: var(--text-primary);
    }

    .strategy-ball-role {
      font-size: 10px;
      color: var(--text-muted);
    }

    .strategy-mechanism {
      margin-top: 16px;
    }

    .strategy-mechanism-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }

    .mechanism-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .mechanism-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .mechanism-item::before {
      content: "";
      width: 6px;
      height: 6px;
      background: var(--accent-primary);
      border-radius: 50%;
      flex-shrink: 0;
    }

    .mechanism-ball-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    /* ========== å¼¹çª— ========== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      max-width: calc(100vw - 40px);
      width: fit-content;
      min-width: 320px;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalIn 0.25s ease;
      box-sizing: border-box;
    }

    @keyframes modalIn {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .modal-header {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
    }

    .modal-header img {
      width: 72px;
      height: 72px;
      object-fit: contain;
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      padding: 8px;
    }

    .modal-header-info h2 {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .modal-header-info .cn-name {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 32px;
      height: 32px;
      background: var(--bg-hover);
      border: none;
      border-radius: 50%;
      color: var(--text-secondary);
      font-size: 18px;
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .modal-close:hover {
      background: var(--accent-danger);
      color: white;
    }

    .modal-body {
      padding: 20px;
      min-width: min-content;
    }

    .modal-section {
      margin-bottom: 20px;
    }

    .modal-section:last-child {
      margin-bottom: 0;
    }

    .modal-section h4 {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }

    .combo-formula {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      flex-wrap: nowrap;
    }

    .combo-ball {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      padding: 8px;
      border-radius: var(--radius-sm);
      transition: var(--transition-fast);
      flex-shrink: 0;
    }

    .combo-ball:hover {
      background: var(--bg-hover);
    }

    .combo-ball img {
      width: 48px;
      height: 48px;
      object-fit: contain;
      border-radius: 6px;
    }

    .combo-ball span {
      font-size: 11px;
      color: var(--text-secondary);
      text-align: center;
      white-space: nowrap;
    }

    .combo-plus,
    .combo-equals {
      flex-shrink: 0;
    }

    .combo-plus {
      font-size: 24px;
      color: var(--text-muted);
      font-weight: 300;
    }

    .combo-equals {
      font-size: 24px;
      color: var(--accent-primary);
    }

    .effect-text {
      font-size: 14px;
      color: var(--text-primary);
      line-height: 1.7;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      border-left: 3px solid var(--accent-primary);
    }

    /* ========== é«˜çº§/è¢«åŠ¨è¿›åŒ–åŒº ========== */
    .advanced-section {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--border-color);
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title::before {
      content: "";
      width: 4px;
      height: 20px;
      background: var(--accent-purple);
      border-radius: 2px;
    }

    .advanced-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 12px;
    }

    .advanced-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .advanced-card:hover {
      border-color: var(--accent-purple);
      background: var(--bg-tertiary);
    }

    .advanced-card img {
      width: 48px;
      height: 48px;
      object-fit: contain;
      border-radius: 6px;
    }

    .advanced-card-info {
      flex: 1;
    }

    .advanced-card-info h4 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .advanced-card-info p {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .advanced-card-info .tags-container {
      margin-top: 6px;
    }

    .advanced-card-info .mini-tag {
      padding: 2px 8px;
      font-size: 10px;
    }

    /* ========== ç©ºçŠ¶æ€ ========== */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* ========== å“åº”å¼ ========== */
    @media (max-width: 768px) {
      /* å…¨å±€å®¹å™¨é™åˆ¶ */
      .header,
      .controls,
      .main-content,
      .advanced-section {
        max-width: 100%;
        overflow-x: hidden;
      }

      .header {
        padding: 16px 12px;
      }

      .header h1 {
        font-size: 20px;
      }

      .header p {
        font-size: 12px;
      }

      .lang-switch {
        padding: 6px 12px;
        font-size: 12px;
        order: -1;
        width: 100%;
      }

      .controls {
        padding: 10px;
        gap: 8px;
        flex-direction: column;
      }

      .search-box {
        min-width: unset;
        max-width: 100%;
        width: 100%;
      }

      .view-tabs {
        width: 100%;
        justify-content: center;
      }

      .main-content {
        padding: 10px;
      }

      /* çŸ©é˜µè¡¨æ ¼ - å…è®¸æ°´å¹³æ»šåŠ¨ */
      .matrix-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        max-width: 100%;
        margin: 0 -10px;
        padding: 0 10px;
      }

      .matrix-table th,
      .matrix-table td {
        width: 45px;
        height: 45px;
        min-width: 45px;
      }

      .matrix-table th img {
        width: 22px;
        height: 22px;
      }

      .matrix-table th span {
        font-size: 7px;
      }

      .matrix-cell img {
        width: 26px;
        height: 26px;
      }

      .matrix-cell .cell-name {
        font-size: 7px;
      }

      /* åˆ—è¡¨è§†å›¾ */
      .list-view {
        grid-template-columns: 1fr;
      }

      .list-card {
        max-width: 100%;
      }

      /* å›¾é‰´è§†å›¾ */
      .gallery-section {
        max-width: 100%;
      }

      .gallery-grid {
        grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
        gap: 8px;
      }

      .gallery-item {
        padding: 10px;
      }

      .gallery-item img {
        width: 44px;
        height: 44px;
      }

      .gallery-item .item-name {
        font-size: 11px;
        word-break: break-word;
      }

      .gallery-item .item-name-cn {
        font-size: 10px;
      }

      /* é«˜çº§è¿›åŒ–åŒºåŸŸ */
      .advanced-section {
        padding-left: 0;
        padding-right: 0;
      }

      .section-title {
        font-size: 16px;
        padding: 0 10px;
      }

      .advanced-grid {
        grid-template-columns: 1fr;
        gap: 8px;
      }

      .advanced-card {
        padding: 10px;
        max-width: 100%;
      }

      .advanced-card img {
        width: 40px;
        height: 40px;
        flex-shrink: 0;
      }

      .advanced-card-info {
        min-width: 0;
        overflow: hidden;
      }

      .advanced-card-info h4 {
        font-size: 13px;
        word-break: break-word;
      }

      .advanced-card-info p {
        font-size: 11px;
        word-break: break-word;
      }

      /* ç§»åŠ¨ç«¯ tooltip ä¼˜åŒ– - å®½åº¦è‡ªé€‚åº”å±å¹• */
      .tooltip {
        left: 10px !important;
        right: 10px !important;
        width: auto !important;
        max-width: none !important;
        min-width: unset !important;
      }

      .tooltip-formula {
        flex-wrap: wrap !important;
        white-space: normal !important;
        justify-content: flex-start;
      }

      .tooltip-formula img {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
      }

      .tooltip-formula span {
        word-break: break-word;
        overflow-wrap: break-word;
      }

      .tooltip-header img {
        width: 40px;
        height: 40px;
        flex-shrink: 0;
      }

      .tooltip-effect {
        word-break: break-word;
        overflow-wrap: break-word;
      }

      /* å¼¹çª—ä¼˜åŒ– */
      .modal-overlay {
        padding: 10px;
      }

      .modal {
        max-width: 100%;
        width: 100%;
        margin: 0;
      }

      .modal-header {
        padding: 16px;
        gap: 12px;
      }

      .modal-header img {
        width: 56px;
        height: 56px;
        flex-shrink: 0;
      }

      .modal-header-info {
        min-width: 0;
        overflow: hidden;
      }

      .modal-header-info h2 {
        font-size: 16px;
        word-break: break-word;
      }

      .modal-body {
        padding: 16px;
      }

      .combo-formula {
        gap: 8px;
        padding: 10px;
        flex-wrap: wrap !important;
        white-space: normal !important;
      }

      .combo-ball {
        padding: 4px;
      }

      .combo-ball img {
        width: 36px;
        height: 36px;
      }

      .combo-ball span {
        font-size: 10px;
        word-break: break-word;
      }

      .combo-plus,
      .combo-equals {
        font-size: 18px;
      }

      .effect-text {
        font-size: 13px;
      }
    }

    /* æ›´å°å±å¹•é€‚é… */
    @media (max-width: 480px) {
      .header {
        padding: 12px 10px;
      }

      .header h1 {
        font-size: 18px;
        letter-spacing: 1px;
      }

      .controls {
        padding: 8px;
      }

      .main-content {
        padding: 8px;
      }

      .matrix-wrapper {
        margin: 0 -8px;
        padding: 0 8px;
      }

      .matrix-table th,
      .matrix-table td {
        width: 38px;
        height: 38px;
        min-width: 38px;
      }

      .matrix-table th img {
        width: 18px;
        height: 18px;
      }

      .matrix-table th span {
        font-size: 6px;
      }

      .matrix-cell img {
        width: 22px;
        height: 22px;
      }

      .matrix-cell .cell-name {
        display: none;
      }

      .gallery-grid {
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 6px;
      }

      .gallery-item {
        padding: 8px;
      }

      .gallery-item img {
        width: 36px;
        height: 36px;
      }

      .gallery-item .item-name {
        font-size: 10px;
      }

      .gallery-item .item-name-cn {
        font-size: 9px;
      }

      .advanced-card {
        padding: 8px;
      }

      .advanced-card img {
        width: 36px;
        height: 36px;
      }

      /* tooltip */
      .tooltip {
        left: 8px !important;
        right: 8px !important;
      }

      /* å¼¹çª— */
      .modal-overlay {
        padding: 8px;
      }

      .modal-header {
        padding: 12px;
      }

      .modal-header img {
        width: 48px;
        height: 48px;
      }

      .modal-body {
        padding: 12px;
      }

      .combo-ball img {
        width: 32px;
        height: 32px;
      }

      .combo-ball span {
        font-size: 9px;
      }
    }

    /* ========== æ»šåŠ¨æ¡ ========== */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* ========== æ‚¬æµ®æç¤ºæ¡† ========== */
    .tooltip {
      position: fixed;
      z-index: 2000;
      background: var(--bg-secondary);
      border: 1px solid var(--accent-primary);
      border-radius: var(--radius-md);
      padding: 12px;
      max-width: calc(100vw - 40px);
      min-width: 0;
      width: fit-content;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      pointer-events: none;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 0.15s ease, transform 0.15s ease;
      overflow: visible;
      box-sizing: border-box;
    }

    .tooltip.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .tooltip-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    .tooltip-header img {
      width: 48px;
      height: 48px;
      object-fit: contain;
      border-radius: 6px;
      background: var(--bg-tertiary);
      padding: 4px;
    }

    .tooltip-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .tooltip-title-cn {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .tooltip-formula {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      flex-wrap: nowrap;
      white-space: nowrap;
      margin-bottom: 10px;
      padding: 8px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-secondary);
      box-sizing: border-box;
    }

    .tooltip-formula img {
      width: 24px;
      height: 24px;
      object-fit: contain;
      border-radius: 4px;
    }

    .tooltip-formula .plus {
      color: var(--text-muted);
    }

    .tooltip-formula .equals {
      color: var(--accent-primary);
      font-weight: bold;
    }

    .tooltip-effect {
      font-size: 12px;
      color: var(--text-primary);
      line-height: 1.5;
      padding: 8px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      border-left: 2px solid var(--accent-primary);
    }

    /* ========== éšè—ç±» ========== */
    .hidden {
      display: none !important;
    }

    /* ========== åŠ è½½æç¤º ========== */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .loading::after {
      content: "";
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-color);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 10px;
      vertical-align: middle;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* ========== é¡µè„š ========== */
    .footer {
      text-align: center;
      padding: 20px;
      margin-top: 40px;
      border-top: 1px solid var(--border-color);
      color: var(--text-muted);
      font-size: 13px;
    }

    .footer .divider {
      margin: 0 12px;
      opacity: 0.5;
    }

    .footer span#busuanzi_value_site_pv,
    .footer span#busuanzi_value_site_uv,
    .footer span#busuanzi_value_page_pv {
      color: var(--accent-primary);
      font-weight: 600;
    }

    /* ========== æ ‡ç­¾ç³»ç»Ÿ ========== */
    .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .tag, .mini-tag {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-secondary);
      white-space: nowrap;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .tag[class*="tag-"], .mini-tag[class*="tag-"] {
      color: white;
    }

    /* ========== ä¼¤å®³ç±»å‹ ========== */
    .damage-types {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .damage-type {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
    }

    .damage-type .icon {
      font-size: 14px;
    }

    /* ========== çŠ¶æ€æ•ˆæœ ========== */
    .status-effects {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .status-effect {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      background: rgba(248, 81, 73, 0.15);
      border: 1px solid rgba(248, 81, 73, 0.3);
      color: #f85149;
    }

    .status-effect .icon {
      font-size: 13px;
    }

    /* ========== AOEç±»å‹ ========== */
    .aoe-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      background: rgba(243, 156, 18, 0.15);
      border: 1px solid rgba(243, 156, 18, 0.3);
      color: #f39c12;
      margin-bottom: 8px;
    }

    /* ========== Tooltip å¢å¼º ========== */
    .tooltip-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--border-color);
    }

    .tooltip-meta {
      margin-bottom: 8px;
    }

    .tooltip-meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 4px;
    }

    /* ========== Modal å¢å¼º ========== */
    .modal-meta {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .modal-meta-section {
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
    }

    .modal-meta-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .modal-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .modal-tag {
      padding: 5px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* ========== å›¾é‰´å¡ç‰‡æ ‡ç­¾ ========== */
    .gallery-item .item-tags {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 4px;
      margin-top: 6px;
    }

    .gallery-item .mini-tag {
      padding: 2px 8px;
      font-size: 9px;
    }

    /* ========== ç­›é€‰æ  ========== */
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      padding: 12px 20px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
    }

    .filter-btn {
      padding: 6px 12px;
      border: 1px solid var(--border-color);
      border-radius: 16px;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      transition: var(--transition-fast);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .filter-btn:hover {
      border-color: var(--accent-primary);
      color: var(--text-primary);
    }

    .filter-btn.active {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: white;
    }

    .filter-btn .icon {
      font-size: 14px;
    }

    @media (max-width: 768px) {
      .filter-bar {
        padding: 8px 10px;
        gap: 6px;
      }
      .filter-btn {
        padding: 4px 8px;
        font-size: 11px;
      }
      .tag, .mini-tag {
        font-size: 9px;
        padding: 2px 8px;
      }
      .damage-type, .status-effect, .aoe-badge {
        font-size: 10px;
        padding: 3px 8px;
      }
    }
  </style>
</head>
<body>

  <!-- å¤´éƒ¨ -->
  <header class="header">
    <h1 data-i18n="title">BALL x PIT è¿›åŒ–å›¾é‰´</h1>
    <p data-i18n="subtitle">å®Œæ•´è¿›åŒ–ç»„åˆå‚è€ƒ</p>
  </header>

  <!-- æ§åˆ¶æ  -->
  <div class="controls">
    <div class="search-box">
      <input 
        type="text" 
        id="searchInput" 
        data-i18n-placeholder="searchPlaceholder"
        placeholder="æœç´¢çƒå..."
        autocomplete="off"
      >
    </div>
    
    <div class="view-tabs">
      <button class="view-tab active" data-view="matrix" data-i18n="viewMatrix">çŸ©é˜µ</button>
      <button class="view-tab" data-view="list" data-i18n="viewList">åˆ—è¡¨</button>
      <button class="view-tab" data-view="gallery" data-i18n="viewGallery">å›¾é‰´</button>
      <button class="view-tab" data-view="strategy" data-i18n="viewStrategy">ç­–ç•¥</button>
    </div>
    
    <button class="lang-switch" id="langSwitch" title="Switch Language">ğŸŒ English</button>
  </div>

  <!-- ç­›é€‰æ  -->
  <div class="filter-bar" id="filterBar">
    <button class="filter-btn active" data-filter="all"><span class="icon">ğŸ¯</span><span data-i18n="filterAll">å…¨éƒ¨</span></button>
    <button class="filter-btn" data-filter="dot"><span class="icon">ğŸ”¥</span><span data-i18n="filterDot">æŒç»­ä¼¤å®³</span></button>
    <button class="filter-btn" data-filter="cc"><span class="icon">â„ï¸</span><span data-i18n="filterCc">æ§åˆ¶</span></button>
    <button class="filter-btn" data-filter="aoe"><span class="icon">ğŸ’¥</span><span data-i18n="filterAoe">èŒƒå›´</span></button>
    <button class="filter-btn" data-filter="summon"><span class="icon">ğŸ•·ï¸</span><span data-i18n="filterSummon">å¬å”¤</span></button>
    <button class="filter-btn" data-filter="lifesteal"><span class="icon">ğŸ§›</span><span data-i18n="filterLifesteal">å¸è¡€</span></button>
    <button class="filter-btn" data-filter="penetrate"><span class="icon">ğŸ‘»</span><span data-i18n="filterPenetrate">ç©¿é€</span></button>
  </div>

  <!-- ä¸»å†…å®¹ -->
  <main class="main-content">
    
    <!-- çŸ©é˜µè§†å›¾ -->
    <div id="matrixView" class="view-container active">
      <div class="matrix-wrapper">
        <table class="matrix-table" id="matrixTable">
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- åˆ—è¡¨è§†å›¾ -->
    <div id="listView" class="view-container">
      <div class="list-view" id="listContainer"></div>
    </div>

    <!-- å›¾é‰´è§†å›¾ -->
    <div id="galleryView" class="view-container">
      <div class="gallery-section">
        <h3 class="gallery-section-title" data-i18n="sectionBasic">åŸºç¡€çƒ Basic Balls</h3>
        <div class="gallery-grid" id="galleryBasic"></div>
      </div>
      <div class="gallery-section">
        <h3 class="gallery-section-title" data-i18n="sectionEvolved">è¿›åŒ–çƒ Evolved Balls</h3>
        <div class="gallery-grid" id="galleryEvolved"></div>
      </div>
      <div class="gallery-section">
        <h3 class="gallery-section-title" data-i18n="sectionAdvanced">é«˜çº§è¿›åŒ– Advanced Evolutions</h3>
        <div class="gallery-grid" id="galleryAdvanced"></div>
      </div>
      <div class="gallery-section">
        <h3 class="gallery-section-title" data-i18n="sectionPassive">è¢«åŠ¨é“å…· Passive Items</h3>
        <div class="gallery-grid" id="galleryPassive"></div>
      </div>
    </div>

    <!-- ç­–ç•¥è§†å›¾ -->
    <div id="strategyView" class="view-container">
      <div class="strategy-filters" id="strategyFilters"></div>
      <div class="strategy-grid" id="strategyGrid"></div>
    </div>

    <!-- é«˜çº§è¿›åŒ–åŒº -->
    <section class="advanced-section" id="advancedSection">
      <h3 class="section-title" data-i18n="advancedTitle">é«˜çº§å¼¹ç è¿›åŒ–</h3>
      <div class="advanced-grid" id="advancedGrid"></div>
    </section>

    <!-- è¢«åŠ¨é“å…·è¿›åŒ–åŒº -->
    <section class="advanced-section" id="passiveSection">
      <h3 class="section-title" data-i18n="passiveTitle">è¢«åŠ¨é“å…·è¿›åŒ–</h3>
      <div class="advanced-grid" id="passiveGrid"></div>
    </section>

  </main>

  <!-- é¡µè„šç»Ÿè®¡ -->
  <footer class="footer">
    <span>ğŸ“Š <span data-i18n="footerVisits">æ€»è®¿é—®é‡</span>: <span id="busuanzi_value_site_pv">--</span> <span data-i18n="footerTimes">æ¬¡</span></span>
    <span class="divider">|</span>
    <span>ğŸ‘¥ <span data-i18n="footerVisitors">æ€»è®¿å®¢</span>: <span id="busuanzi_value_site_uv">--</span> <span data-i18n="footerPeople">äºº</span></span>
    <span class="divider">|</span>
    <span>ğŸ“„ <span data-i18n="footerPageViews">æœ¬é¡µæµè§ˆ</span>: <span id="busuanzi_value_page_pv">--</span> <span data-i18n="footerTimes">æ¬¡</span></span>
  </footer>

  <!-- æ‚¬æµ®æç¤ºæ¡† -->
  <div class="tooltip" id="tooltip">
    <div class="tooltip-header">
      <img id="tooltipImg" src="" alt="">
      <div class="tooltip-title-wrap">
        <div class="tooltip-title" id="tooltipTitle"></div>
        <div class="tooltip-title-cn" id="tooltipTitleCn"></div>
      </div>
    </div>
    <div class="tooltip-meta" id="tooltipMeta"></div>
    <div class="tooltip-effect" id="tooltipEffect"></div>
    <div class="tooltip-formula" id="tooltipFormula"></div>
    <div class="tooltip-tags" id="tooltipTags"></div>
  </div>

  <!-- è¯¦æƒ…å¼¹çª— -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <button class="modal-close" id="modalClose">&times;</button>
      <div class="modal-header">
        <img id="modalImg" src="" alt="">
        <div class="modal-header-info">
          <h2 id="modalTitle"></h2>
          <div class="cn-name" id="modalTitleCn"></div>
        </div>
      </div>
      <div class="modal-body">
        <div class="modal-section">
          <h4 data-i18n="modalRecipe">åˆæˆé…æ–¹ / Recipe</h4>
          <div class="combo-formula" id="modalFormula"></div>
        </div>
        <div class="modal-section" id="modalMetaSection">
          <h4 data-i18n="modalAttributes">å±æ€§ä¿¡æ¯ / Attributes</h4>
          <div class="modal-meta" id="modalMeta"></div>
        </div>
        <div class="modal-section">
          <h4 data-i18n="modalEffect">æ•ˆæœæè¿° / Effect</h4>
          <div class="effect-text" id="modalEffect"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- å¼•å…¥å¤–éƒ¨æ•°æ®æ–‡ä»¶ -->
  <script src="data/i18n.js"></script>
  <script src="data/gameData.js"></script>
  
  <!-- ä¸è’œå­è®¿é—®ç»Ÿè®¡ (åªåœ¨ http/https ä¸‹åŠ è½½, é¿å… file:// åè®®ä¸‹è¶…æ—¶) -->
  <script>
    if (location.protocol === 'http:' || location.protocol === 'https:') {
      var s = document.createElement('script');
      s.src = 'https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js';
      s.async = true;
      document.head.appendChild(s);
    }
  </script>
  
  <script>
    // ========== ä»å¤–éƒ¨æ•°æ®æ–‡ä»¶åŠ è½½ ==========
    const BASE_BALLS = GAME_DATA.baseBalls;
    const EVOLUTIONS = GAME_DATA.evolutions;
    const ADVANCED_EVOLUTIONS = GAME_DATA.advancedEvolutions;
    const BASE_ITEMS = GAME_DATA.baseItems;
    const PASSIVE_EVOLUTIONS = GAME_DATA.passiveEvolutions;

    // ========== å…¨å±€å˜é‡ ==========
    let currentView = 'matrix';
    let currentLang = 'zh'; // é»˜è®¤ä¸­æ–‡
    try {
      currentLang = localStorage.getItem('lang') || 'zh';
    } catch (e) {
      console.warn('æ— æ³•è¯»å– localStorage:', e);
    }
    const IMG_BASE = 'img/';
    let searchTimeout = null;

    // ========== æ•°æ®ç´¢å¼• (O(1) æŸ¥æ‰¾) ==========
    const ballById = new Map();
    const ballByName = new Map();
    const evoByName = new Map();
    const itemByName = new Map();
    const evoMatrix = new Map();

    function buildIndexes() {
      BASE_BALLS.forEach(b => {
        ballById.set(b.id, b);
        ballByName.set(b.name, b);
      });
      EVOLUTIONS.forEach(e => evoByName.set(e.name, e));
      ADVANCED_EVOLUTIONS.forEach(e => evoByName.set(e.name, e));
      PASSIVE_EVOLUTIONS.forEach(e => evoByName.set(e.name, e));
      BASE_ITEMS.forEach(i => itemByName.set(i.name, i));
      // çŸ©é˜µç´¢å¼•: "ROW_COL" -> evolution
      EVOLUTIONS.forEach(e => {
        evoMatrix.set(`${e.row}_${e.col}`, e);
        evoMatrix.set(`${e.col}_${e.row}`, e);
      });
    }

    // ========== DOM ç¼“å­˜ ==========
    const DOM = {};
    function cacheDOM() {
      DOM.tooltip = document.getElementById('tooltip');
      DOM.tooltipImg = document.getElementById('tooltipImg');
      DOM.tooltipTitle = document.getElementById('tooltipTitle');
      DOM.tooltipTitleCn = document.getElementById('tooltipTitleCn');
      DOM.tooltipEffect = document.getElementById('tooltipEffect');
      DOM.tooltipFormula = document.getElementById('tooltipFormula');
      DOM.tooltipMeta = document.getElementById('tooltipMeta');
      DOM.tooltipTags = document.getElementById('tooltipTags');
      DOM.modalOverlay = document.getElementById('modalOverlay');
      DOM.modalImg = document.getElementById('modalImg');
      DOM.modalTitle = document.getElementById('modalTitle');
      DOM.modalTitleCn = document.getElementById('modalTitleCn');
      DOM.modalEffect = document.getElementById('modalEffect');
      DOM.modalFormula = document.getElementById('modalFormula');
      DOM.modalMeta = document.getElementById('modalMeta');
      DOM.modalMetaSection = document.getElementById('modalMetaSection');
      DOM.searchInput = document.getElementById('searchInput');
      DOM.matrixTable = document.getElementById('matrixTable');
      DOM.listContainer = document.getElementById('listContainer');
      DOM.galleryBasic = document.getElementById('galleryBasic');
      DOM.galleryEvolved = document.getElementById('galleryEvolved');
      DOM.galleryAdvanced = document.getElementById('galleryAdvanced');
      DOM.galleryPassive = document.getElementById('galleryPassive');
      DOM.advancedGrid = document.getElementById('advancedGrid');
      DOM.passiveGrid = document.getElementById('passiveGrid');
      DOM.advancedSection = document.getElementById('advancedSection');
      DOM.passiveSection = document.getElementById('passiveSection');
      DOM.filterBar = document.getElementById('filterBar');
    }

    // ========== å½“å‰ç­›é€‰çŠ¶æ€ ==========
    let currentFilter = 'all';

    // ========== è§†å›¾æ¸²æŸ“çŠ¶æ€è¿½è¸ª ==========
    // è®°å½•æ¯ä¸ªè§†å›¾æ˜¯å¦å·²æ¸²æŸ“, é¿å…é‡å¤æ¸²æŸ“
    const viewRendered = {
      matrix: false,
      list: false,
      gallery: false,
      strategy: false
    };

    // ========== ç”Ÿæˆæ ‡ç­¾ HTML ==========
    function buildTagsHtml(item, size = 'normal') {
      if (!item.tags || item.tags.length === 0) return '';
      const cls = size === 'mini' ? 'mini-tag' : 'tag';
      return item.tags.map(tag => 
        `<span class="${cls} tag-${tag.id}" style="background-color: ${tag.color}">${getTagName(tag)}</span>`
      ).join('');
    }

    // ========== ç”Ÿæˆä¼¤å®³ç±»å‹ HTML ==========
    // è¿‡æ»¤æ‰ä¸çŠ¶æ€æ•ˆæœé‡å¤çš„ä¼¤å®³ç±»å‹ (åŒåå…ƒç´ åªåœ¨çŠ¶æ€æ•ˆæœåŒºæ˜¾ç¤º)
    function buildDamageTypesHtml(item) {
      // è·å–ä¼¤å®³ç±»å‹åˆ—è¡¨
      let types = [];
      if (item.damageType) types.push(item.damageType);
      if (item.damageTypes) types = types.concat(item.damageTypes);
      if (types.length === 0) return '';
      
      // å»é‡
      let unique = [...new Map(types.map(t => [t.id, t])).values()];
      
      // è¿‡æ»¤æ‰ä¸çŠ¶æ€æ•ˆæœåç§°é‡å¤çš„ä¼¤å®³ç±»å‹
      if (item.statusEffects && item.statusEffects.length > 0) {
        const statusIds = new Set(item.statusEffects.map(s => s.id));
        unique = unique.filter(t => !statusIds.has(t.id));
      }
      
      if (unique.length === 0) return '';
      return `<div class="damage-types">${unique.map(t => 
        `<span class="damage-type"><span class="icon">${t.icon}</span>${getDamageTypeName(t)}</span>`
      ).join('')}</div>`;
    }

    // ========== ç”ŸæˆçŠ¶æ€æ•ˆæœ HTML ==========
    function buildStatusEffectsHtml(item) {
      if (!item.statusEffects || item.statusEffects.length === 0) return '';
      // å»é‡
      const unique = [...new Map(item.statusEffects.map(s => [s.id, s])).values()];
      return `<div class="status-effects">${unique.map(s => 
        `<span class="status-effect" title="${getStatusEffectDesc(s)}"><span class="icon">${s.icon}</span>${getStatusEffectName(s)}</span>`
      ).join('')}</div>`;
    }

    // ========== ç”ŸæˆAOEç±»å‹ HTML ==========
    function buildAoeHtml(item) {
      if (!item.aoeType) return '';
      const aoe = item.aoeType;
      return `<div class="aoe-badge"><span class="icon">${aoe.icon}</span>${getAoeTypeName(aoe)}: ${getAoeTypeDesc(aoe)}</div>`;
    }

    // ========== æ£€æŸ¥itemæ˜¯å¦åŒ¹é…ç­›é€‰ ==========
    function matchesFilter(item, filter) {
      if (filter === 'all') return true;
      if (!item.tags) return false;
      return item.tags.some(tag => tag.id === filter);
    }

    // ========== å·¥å…·å‡½æ•° ==========
    function getImg(filename) {
      return IMG_BASE + (filename || 'ball_icon_bleed.png');
    }

    // è½¬ä¹‰æ’‡å·, ä»…ç”¨äºå†…è” JavaScript å­—ç¬¦ä¸²
    // æ­£ç¡®ç”¨æ³•: onclick="func('${safeName(name)}')"
    // é”™è¯¯ç”¨æ³•: data-evo="${safeName(name)}"  (data-* å±æ€§ä¸éœ€è¦è½¬ä¹‰!)
    // åŸå› : data-* å±æ€§å€¼ä¼šè¢«æµè§ˆå™¨åŸæ ·ä¿å­˜, è½¬ä¹‰å­—ç¬¦ä¼šå˜æˆå­—é¢å­—ç¬¦
    function safeName(str) {
      return str ? str.replace(/'/g, "\\'") : '';
    }

    // ç”Ÿæˆå›¾ç‰‡ HTML
    function imgHtml(src, alt, className) {
      const cls = className ? ` class="${className}"` : '';
      return `<img${cls} src="${getImg(src)}" alt="${alt || ''}" onerror="this.src='${getImg('placeholder.png')}'">`;
    }

    // ========== è¯­è¨€ç›¸å…³å‡½æ•° ==========
    function getName(item) {
      if (currentLang === 'en') {
        return item.name;
      }
      return item.nameCn || item.name;
    }

    function getEffect(item) {
      if (currentLang === 'en') {
        return item.effect || item.effectCn || '';
      }
      return item.effectCn || item.effect || '';
    }

    // è·å–æ ‡ç­¾åç§°
    function getTagName(tag) {
      if (currentLang === 'en') {
        return tag.name;
      }
      return tag.nameCn || tag.name;
    }

    // è·å–ä¼¤å®³ç±»å‹åç§°
    function getDamageTypeName(type) {
      if (currentLang === 'en') {
        return type.name;
      }
      return type.nameCn || type.name;
    }

    // è·å–çŠ¶æ€æ•ˆæœåç§°
    function getStatusEffectName(effect) {
      if (currentLang === 'en') {
        return effect.name;
      }
      return effect.nameCn || effect.name;
    }

    // è·å–çŠ¶æ€æ•ˆæœæè¿°
    function getStatusEffectDesc(effect) {
      if (currentLang === 'en') {
        return effect.desc || effect.descCn || '';
      }
      return effect.descCn || effect.desc || '';
    }

    // è·å– AOE ç±»å‹åç§°
    function getAoeTypeName(aoe) {
      if (currentLang === 'en') {
        return aoe.name;
      }
      return aoe.nameCn || aoe.name;
    }

    // è·å– AOE ç±»å‹æè¿°
    function getAoeTypeDesc(aoe) {
      if (currentLang === 'en') {
        return aoe.desc || aoe.descCn || '';
      }
      return aoe.descCn || aoe.desc || '';
    }

    // æ›´æ–°ç•Œé¢æ–‡å­—
    function updateUIText() {
      // ç¡®ä¿ I18N å¯¹è±¡å­˜åœ¨
      if (typeof I18N === 'undefined') {
        console.error('I18N å¯¹è±¡æœªå®šä¹‰, è¯·æ£€æŸ¥ i18n.js æ˜¯å¦æ­£ç¡®åŠ è½½');
        return;
      }
      
      const texts = I18N[currentLang];
      if (!texts) {
        console.error('è¯­è¨€é…ç½®ä¸å­˜åœ¨:', currentLang);
        return;
      }
      
      // æ›´æ–°æ‰€æœ‰å¸¦ data-i18n å±æ€§çš„å…ƒç´ 
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        if (texts[key]) {
          el.textContent = texts[key];
        }
      });
      
      // æ›´æ–° placeholder
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.dataset.i18nPlaceholder;
        if (texts[key]) {
          el.placeholder = texts[key];
        }
      });
      
      // æ›´æ–°è¯­è¨€åˆ‡æ¢æŒ‰é’®æ–‡å­—
      const langBtn = document.getElementById('langSwitch');
      if (langBtn && texts.langSwitch) {
        langBtn.textContent = texts.langSwitch;
      }
      
      // æ›´æ–°é¡µé¢æ ‡é¢˜
      if (texts.title) {
        document.title = texts.title;
      }
    }

    // åˆ‡æ¢è¯­è¨€
    function switchLanguage() {
      currentLang = currentLang === 'zh' ? 'en' : 'zh';
      localStorage.setItem('lang', currentLang);
      
      // æ›´æ–°ç•Œé¢æ–‡å­—
      updateUIText();
      
      // é‡æ–°æ¸²æŸ“æ‰€æœ‰è§†å›¾
      renderAll();
      
      // é‡æ–°åº”ç”¨å½“å‰ç­›é€‰
      applyFilter(currentFilter);
    }

    function getBaseBall(id) {
      return ballById.get(id);
    }

    function getBaseItem(name) {
      return itemByName.get(name);
    }

    function getEvolution(name) {
      return evoByName.get(name);
    }

    function findEvolution(rowId, colId) {
      return evoMatrix.get(`${rowId}_${colId}`);
    }

    // ç»Ÿä¸€æŸ¥æ‰¾ç»„ä»¶ (åŸºç¡€çƒ/è¿›åŒ–çƒ/è£…å¤‡)
    function findComponent(name) {
      return ballByName.get(name) || evoByName.get(name) || itemByName.get(name);
    }

    // è·å–ç»„ä»¶åç§° (æ ¹æ®å½“å‰è¯­è¨€)
    function getComponentName(name) {
      const comp = findComponent(name);
      if (!comp) return name;
      return getName(comp);
    }

    // ========== çŸ©é˜µè§†å›¾ ==========
    function renderMatrix() {
      let html = '<tr><th></th>';
      
      // è¡¨å¤´
      BASE_BALLS.forEach(ball => {
        html += `<th data-id="${ball.id}" data-type="base">
          ${imgHtml(ball.img, ball.name)}
          <span>${getName(ball)}</span>
        </th>`;
      });
      html += '</tr>';

      // è¡¨ä½“
      BASE_BALLS.forEach(rowBall => {
        html += `<tr><th data-id="${rowBall.id}" data-type="base">
          ${imgHtml(rowBall.img, rowBall.name)}
          <span>${getName(rowBall)}</span>
        </th>`;

        BASE_BALLS.forEach(colBall => {
          const evo = findEvolution(rowBall.id, colBall.id);
          if (evo) {
            html += `<td class="matrix-cell" data-evo="${evo.name}" data-type="evo">
              ${imgHtml(evo.img, evo.name)}
              <div class="cell-name">${getName(evo)}${evo.alt ? '*' : ''}</div>
            </td>`;
          }
          else {
            html += `<td class="matrix-cell empty"></td>`;
          }
        });

        html += '</tr>';
      });

      DOM.matrixTable.innerHTML = html;
    }

    // ========== åˆ—è¡¨è§†å›¾ ==========
    function renderList() {
      let html = '';
      const combosText = (I18N && I18N[currentLang]) ? I18N[currentLang].combosCount : 'ç§ç»„åˆ';

      BASE_BALLS.forEach(baseBall => {
        const combos = EVOLUTIONS.filter(e => e.row === baseBall.id || e.col === baseBall.id);
        if (combos.length === 0) return;

        html += `<div class="list-card">
          <div class="list-card-header">
            ${imgHtml(baseBall.img, baseBall.name)}
            <div>
              <h3>${getName(baseBall)}</h3>
              <div class="subtitle">${combos.length} ${combosText}</div>
            </div>
          </div>
          <div class="list-card-body">`;

        combos.forEach(evo => {
          const partnerId = evo.row === baseBall.id ? evo.col : evo.row;
          const partner = getBaseBall(partnerId);
          if (!partner) return;
          const tagsData = evo.tags ? evo.tags.map(t => t.id).join(',') : '';

          html += `<div class="combo-item" data-evo="${evo.name}" data-tags="${tagsData}">
            ${imgHtml(evo.img, evo.name)}
            <div class="combo-text">
              <span class="partner">+ ${getName(partner)}</span>
              <span class="arrow">â†’</span>
              <span class="result">${getName(evo)}${evo.alt ? '*' : ''}</span>
            </div>
          </div>`;
        });

        html += '</div></div>';
      });

      DOM.listContainer.innerHTML = html;
    }

    // ========== å›¾é‰´è§†å›¾ ==========
    // ç”Ÿæˆå›¾é‰´é¡¹ HTML
    // æ³¨æ„: data-* å±æ€§ä½¿ç”¨åŸå§‹å€¼, ä¸éœ€è¦ safeName() è½¬ä¹‰
    function galleryItemHtml(item, type, idOrName) {
      const dataAttr = type === 'base' ? `data-id="${idOrName}"` : `data-evo="${idOrName}"`;
      // ä½¿ç”¨é¢„è®¡ç®—çš„ tagsData, é¿å…æ¸²æŸ“æ—¶é‡å¤è®¡ç®—
      const tagsData = item.tagsData || '';
      const tagsHtml = buildTagsHtml(item, 'mini');
      // æ ¹æ®è¯­è¨€æ˜¾ç¤ºåç§° (åªæ˜¾ç¤ºå½“å‰è¯­è¨€)
      const displayName = getName(item);
      return `<div class="gallery-item" ${dataAttr} data-type="${type}" data-tags="${tagsData}">
        ${imgHtml(item.img, item.name)}
        <div class="item-name">${displayName}</div>
        ${tagsHtml ? `<div class="item-tags">${tagsHtml}</div>` : ''}
      </div>`;
    }

    function renderGallery() {
      // åŸºç¡€çƒ
      DOM.galleryBasic.innerHTML = BASE_BALLS.map(b => galleryItemHtml(b, 'base', b.id)).join('');

      // è¿›åŒ–çƒ (å»é‡)
      const uniqueEvos = [...new Map(EVOLUTIONS.map(e => [e.name, e])).values()];
      DOM.galleryEvolved.innerHTML = uniqueEvos.map(e => galleryItemHtml(e, 'evo', e.name)).join('');

      // é«˜çº§è¿›åŒ–
      DOM.galleryAdvanced.innerHTML = ADVANCED_EVOLUTIONS.map(e => galleryItemHtml(e, 'evo', e.name)).join('');

      // è¢«åŠ¨é“å…·
      DOM.galleryPassive.innerHTML = PASSIVE_EVOLUTIONS.map(e => galleryItemHtml(e, 'evo', e.name)).join('');
    }

    // ========== ç­–ç•¥è§†å›¾ ==========
    let currentStrategyFilter = 'all';

    // æ ¹æ®çƒåç§°æŸ¥æ‰¾çƒæ•°æ®
    function findBallData(ballName) {
      // å…ˆä»åŸºç¡€çƒä¸­æŸ¥æ‰¾ (ä½¿ç”¨ id æˆ– name)
      let ball = BASE_BALLS.find(b => b.id === ballName || b.name === ballName);
      if (ball) return { data: ball, type: 'base' };
      
      // ä»è¿›åŒ–çƒä¸­æŸ¥æ‰¾
      ball = EVOLUTIONS.find(e => e.name === ballName);
      if (ball) return { data: ball, type: 'evo' };
      
      // ä»é«˜çº§è¿›åŒ–ä¸­æŸ¥æ‰¾
      ball = ADVANCED_EVOLUTIONS.find(e => e.name === ballName);
      if (ball) return { data: ball, type: 'evo' };
      
      return null;
    }

    // ç”Ÿæˆç­–ç•¥å¡ç‰‡ä¸­çš„çƒå…ƒç´  HTML
    function strategyBallHtml(ballName, role, roleCn, isCore) {
      const ballInfo = findBallData(ballName);
      if (!ballInfo) {
        return `<div class="strategy-ball ${isCore ? 'core' : ''}">
          <span class="strategy-ball-name">${ballName}</span>
        </div>`;
      }
      
      const { data, type } = ballInfo;
      const displayName = getName(data);
      const displayRole = currentLang === 'zh' ? roleCn : role;
      const dataAttr = type === 'base' ? `data-id="${data.id}"` : `data-evo="${data.name}"`;
      
      return `<div class="strategy-ball ${isCore ? 'core' : ''}" ${dataAttr} data-type="${type}">
        ${imgHtml(data.img, data.name)}
        <div>
          <div class="strategy-ball-name">${displayName}</div>
          ${displayRole ? `<div class="strategy-ball-role">${displayRole}</div>` : ''}
        </div>
      </div>`;
    }

    // ç”Ÿæˆç­–ç•¥å¡ç‰‡ HTML
    function strategyCardHtml(strategy) {
      const t = I18N[currentLang];
      const name = currentLang === 'zh' ? strategy.nameCn : strategy.name;
      const nameSub = currentLang === 'zh' ? strategy.name : strategy.nameCn;
      const desc = currentLang === 'zh' ? strategy.descCn : strategy.desc;
      
      // éš¾åº¦å’Œå¼ºåº¦æ˜Ÿæ˜Ÿ
      const difficultyStars = 'â˜…'.repeat(strategy.difficulty) + 'â˜†'.repeat(3 - strategy.difficulty);
      const ratingStars = 'â˜…'.repeat(strategy.rating) + 'â˜†'.repeat(5 - strategy.rating);
      
      // æ ¸å¿ƒçƒ
      const coreBallsHtml = strategy.core.map(ballName => {
        const mech = strategy.mechanism.find(m => m.ball === ballName);
        return strategyBallHtml(ballName, mech?.role || '', mech?.roleCn || '', true);
      }).join('');
      
      // ååŒçƒ
      const synergyBallsHtml = strategy.synergy.map(ballName => {
        const mech = strategy.mechanism.find(m => m.ball === ballName);
        return strategyBallHtml(ballName, mech?.role || '', mech?.roleCn || '', false);
      }).join('');
      
      // æœºåˆ¶è¯´æ˜
      const mechanismHtml = strategy.mechanism.map(m => {
        const role = currentLang === 'zh' ? m.roleCn : m.role;
        return `<div class="mechanism-item">
          <span class="mechanism-ball-name">${m.ball}:</span> ${role}
        </div>`;
      }).join('');
      
      return `<div class="strategy-card" data-type="${strategy.type.id}">
        <div class="strategy-header">
          <div class="strategy-title">
            <div class="strategy-type-badge" style="background: ${strategy.type.color}20; color: ${strategy.type.color}">
              ${getTypeIcon(strategy.type.id)}
            </div>
            <div>
              <div class="strategy-name">${name}</div>
              <div class="strategy-name-cn">${nameSub}</div>
            </div>
          </div>
          <div class="strategy-meta">
            <div class="strategy-difficulty">${t.strategyDifficulty}: <span class="strategy-stars">${difficultyStars}</span></div>
            <div class="strategy-rating">${t.strategyRating}: <span class="strategy-stars">${ratingStars}</span></div>
          </div>
        </div>
        <div class="strategy-body">
          <div class="strategy-desc">${desc}</div>
          
          <div class="strategy-balls-section">
            <div class="strategy-balls-title">${t.strategyCore}</div>
            <div class="strategy-balls">${coreBallsHtml}</div>
          </div>
          
          <div class="strategy-balls-section">
            <div class="strategy-balls-title">${t.strategySynergy}</div>
            <div class="strategy-balls">${synergyBallsHtml}</div>
          </div>
          
          <div class="strategy-mechanism">
            <div class="strategy-mechanism-title">${t.strategyMechanism}</div>
            <div class="mechanism-list">${mechanismHtml}</div>
          </div>
        </div>
      </div>`;
    }

    // è·å–ç­–ç•¥ç±»å‹å›¾æ ‡
    function getTypeIcon(typeId) {
      const icons = {
        dmgAmp: 'âš”ï¸',
        sustain: 'â¤ï¸',
        control: 'ğŸ”’',
        aoeCombo: 'ğŸ’¥',
        dotStack: 'ğŸ©¸',
        summonArmy: 'ğŸ‘¾'
      };
      return icons[typeId] || 'ğŸ¯';
    }

    // æ¸²æŸ“ç­–ç•¥ç­›é€‰æŒ‰é’®
    function renderStrategyFilters() {
      const t = I18N[currentLang];
      const filters = [
        { id: 'all', label: t.filterAll },
        { id: 'dmgAmp', label: t.filterDmgAmp, color: SYNERGY_TYPE.DAMAGE_AMP.color },
        { id: 'sustain', label: t.filterSustain, color: SYNERGY_TYPE.SUSTAIN.color },
        { id: 'control', label: t.filterControl, color: SYNERGY_TYPE.CONTROL.color },
        { id: 'aoeCombo', label: t.filterAoeCombo, color: SYNERGY_TYPE.AOE_COMBO.color },
        { id: 'dotStack', label: t.filterDotStack, color: SYNERGY_TYPE.DOT_STACK.color },
        { id: 'summonArmy', label: t.filterSummonArmy, color: SYNERGY_TYPE.SUMMON_ARMY.color }
      ];
      
      const filtersContainer = document.getElementById('strategyFilters');
      filtersContainer.innerHTML = filters.map(f => {
        const activeClass = f.id === currentStrategyFilter ? 'active' : '';
        const style = f.color && f.id === currentStrategyFilter ? `background: ${f.color}; border-color: ${f.color};` : '';
        return `<button class="strategy-filter-btn ${activeClass}" data-filter="${f.id}" style="${style}">${f.label}</button>`;
      }).join('');
      
      // ç»‘å®šç­›é€‰äº‹ä»¶
      filtersContainer.querySelectorAll('.strategy-filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          currentStrategyFilter = btn.dataset.filter;
          renderStrategyFilters();
          renderStrategyGrid();
        });
      });
    }

    // æ¸²æŸ“ç­–ç•¥å¡ç‰‡ç½‘æ ¼
    function renderStrategyGrid() {
      const grid = document.getElementById('strategyGrid');
      const filtered = currentStrategyFilter === 'all' 
        ? STRATEGIES 
        : STRATEGIES.filter(s => s.type.id === currentStrategyFilter);
      
      grid.innerHTML = filtered.map(s => strategyCardHtml(s)).join('');
      
      // ä¸ºç­–ç•¥å¡ç‰‡ä¸­çš„çƒå…ƒç´ ç»‘å®šç‚¹å‡»äº‹ä»¶
      grid.querySelectorAll('.strategy-ball[data-id], .strategy-ball[data-evo]').forEach(el => {
        el.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = el.dataset.id;
          const evoName = el.dataset.evo;
          
          // ä½¿ç”¨ openModal, å®ƒæ”¯æŒé€šè¿‡ id æˆ– name æŸ¥æ‰¾åŸºç¡€çƒå’Œè¿›åŒ–çƒ
          if (id) {
            openModal(id);
          }
          else if (evoName) {
            openModal(evoName);
          }
        });
      });
    }

    // æ¸²æŸ“ç­–ç•¥è§†å›¾
    function renderStrategy() {
      renderStrategyFilters();
      renderStrategyGrid();
    }

    // ========== é«˜çº§/è¢«åŠ¨è¿›åŒ–åŒº ==========
    // ç”Ÿæˆé«˜çº§å¡ç‰‡ HTML
    // æ³¨æ„: data-evo ä½¿ç”¨åŸå§‹å€¼, ä¸éœ€è¦ safeName() è½¬ä¹‰
    function advancedCardHtml(evo) {
      const componentsText = evo.components.map(c => getComponentName(c)).join(' + ');
      // ä½¿ç”¨é¢„è®¡ç®—çš„ tagsData, é¿å…æ¸²æŸ“æ—¶é‡å¤è®¡ç®—
      const tagsData = evo.tagsData || '';
      const tagsHtml = buildTagsHtml(evo, 'mini');
      return `<div class="advanced-card" data-evo="${evo.name}" data-type="evo" data-tags="${tagsData}">
        ${imgHtml(evo.img, evo.name)}
        <div class="advanced-card-info">
          <h4>${getName(evo)}</h4>
          <p>${componentsText}</p>
          ${tagsHtml ? `<div class="tags-container">${tagsHtml}</div>` : ''}
        </div>
      </div>`;
    }

    function renderAdvancedSections() {
      DOM.advancedGrid.innerHTML = ADVANCED_EVOLUTIONS.map(advancedCardHtml).join('');
      DOM.passiveGrid.innerHTML = PASSIVE_EVOLUTIONS.map(advancedCardHtml).join('');
    }

    // ========== æ‚¬æµ®æç¤ºæ¡† ==========
    // æ„å»ºé…æ–¹ HTML
    function buildFormulaHtml(item) {
      let html = '';
      
      if (item.row && item.col) {
        // åŸºç¡€è¿›åŒ–: ä¸¤ä¸ªåŸºç¡€çƒç»„åˆ
        const ball1 = getBaseBall(item.row);
        const ball2 = getBaseBall(item.col);
        if (ball1) html += `<img src="${getImg(ball1.img)}"><span>${getName(ball1)}</span>`;
        html += '<span class="plus">+</span>';
        if (ball2) html += `<img src="${getImg(ball2.img)}"><span>${getName(ball2)}</span>`;
        html += '<span class="equals">=</span>';
        html += `<img src="${getImg(item.img)}"><span>${getName(item)}</span>`;
      }
      else if (item.components) {
        // é«˜çº§/è¢«åŠ¨è¿›åŒ–: å¤šä¸ªç»„ä»¶
        item.components.forEach((comp, i) => {
          const c = findComponent(comp);
          if (c) {
            html += `<img src="${getImg(c.img)}"><span>${getName(c)}</span>`;
          }
          else {
            html += `<span>${comp}</span>`;
          }
          if (i < item.components.length - 1) html += '<span class="plus">+</span>';
        });
        html += '<span class="equals">=</span>';
        html += `<img src="${getImg(item.img)}"><span>${getName(item)}</span>`;
      }
      
      return html;
    }

    // è®¡ç®— tooltip ä½ç½® (åŠ¨æ€è·å–å®é™…å°ºå¯¸, ä¼˜åŒ–ç§»åŠ¨ç«¯æ˜¾ç¤º)
    function calcTooltipPosition(targetRect, tooltipRect) {
      const padding = 10;
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      const isMobile = viewportWidth < 768;
      
      let left, top;
      
      // ç§»åŠ¨ç«¯: æ°´å¹³ä½ç½®ç”± CSS æ§åˆ¶, åªè®¡ç®—å‚ç›´ä½ç½®
      if (isMobile) {
        left = padding; // CSS ä¼šç”¨ !important è¦†ç›–
        
        // ä¼˜å…ˆæ”¾åœ¨ä¸Šæ–¹
        const spaceAbove = targetRect.top;
        const spaceBelow = viewportHeight - targetRect.bottom;
        
        if (spaceAbove >= tooltipRect.height + padding) {
          top = targetRect.top - tooltipRect.height - padding;
        } else if (spaceBelow >= tooltipRect.height + padding) {
          top = targetRect.bottom + padding;
        } else {
          // ç©ºé—´éƒ½ä¸å¤Ÿ, é€‰æ‹©ç©ºé—´å¤§çš„ä¸€ä¾§
          if (spaceAbove > spaceBelow) {
            top = padding;
          } else {
            top = viewportHeight - tooltipRect.height - padding;
          }
        }
      } else {
        // æ¡Œé¢ç«¯: ä¼˜å…ˆæ”¾åœ¨å³ä¾§
        left = targetRect.right + padding;
        top = targetRect.top;
        
        // å³ä¾§æ”¾ä¸ä¸‹, å°è¯•å·¦ä¾§
        if (left + tooltipRect.width > viewportWidth - padding) {
          left = targetRect.left - tooltipRect.width - padding;
        }
        // å·¦ä¾§ä¹Ÿæ”¾ä¸ä¸‹, æ”¾åœ¨ç›®æ ‡ä¸‹æ–¹
        if (left < padding) {
          left = Math.max(padding, targetRect.left);
          top = targetRect.bottom + padding;
        }
        
        // ç¡®ä¿ä¸è¶…å‡ºå³è¾¹ç•Œ
        if (left + tooltipRect.width > viewportWidth - padding) {
          left = viewportWidth - tooltipRect.width - padding;
        }
        // ç¡®ä¿ä¸è¶…å‡ºå·¦è¾¹ç•Œ
        if (left < padding) left = padding;
      }
      
      // ç¡®ä¿ä¸è¶…å‡ºä¸‹è¾¹ç•Œ
      if (top + tooltipRect.height > viewportHeight - padding) {
        top = viewportHeight - tooltipRect.height - padding;
      }
      // ç¡®ä¿ä¸è¶…å‡ºä¸Šè¾¹ç•Œ
      if (top < padding) top = padding;

      return { left, top };
    }

    function showTooltip(event, name, type) {
      const item = type === 'base' ? getBaseBall(name) : getEvolution(name);
      if (!item) return;

      // å¡«å……å†…å®¹ (ä½¿ç”¨ç¼“å­˜çš„ DOM)
      DOM.tooltipImg.src = getImg(item.img);
      // æ ¹æ®è¯­è¨€è®¾ç½®ä¸»æ ‡é¢˜å’Œå‰¯æ ‡é¢˜
      const primaryName = currentLang === 'en' ? item.name : (item.nameCn || item.name);
      const secondaryName = currentLang === 'en' ? (item.nameCn || '') : item.name;
      DOM.tooltipTitle.textContent = primaryName;
      DOM.tooltipTitleCn.textContent = secondaryName;
      DOM.tooltipEffect.textContent = getEffect(item);

      // å…ƒæ•°æ® (ä¼¤å®³ç±»å‹, çŠ¶æ€æ•ˆæœ, AOE)
      let metaHtml = buildDamageTypesHtml(item) + buildStatusEffectsHtml(item) + buildAoeHtml(item);
      DOM.tooltipMeta.innerHTML = metaHtml;
      DOM.tooltipMeta.style.display = metaHtml ? 'block' : 'none';

      // æ ‡ç­¾
      const tagsHtml = buildTagsHtml(item);
      DOM.tooltipTags.innerHTML = tagsHtml;
      DOM.tooltipTags.style.display = tagsHtml ? 'flex' : 'none';

      // é…æ–¹
      const formulaHtml = buildFormulaHtml(item);
      DOM.tooltipFormula.innerHTML = formulaHtml;
      DOM.tooltipFormula.style.display = formulaHtml ? 'flex' : 'none';

      const isMobile = window.innerWidth < 768;
      
      // å…ˆä¸´æ—¶æ˜¾ç¤ºä»¥è·å–å®é™…å°ºå¯¸
      DOM.tooltip.style.visibility = 'hidden';
      DOM.tooltip.style.top = '0';
      // ç§»åŠ¨ç«¯ä¸è®¾ç½® left, è®© CSS æ§åˆ¶æ°´å¹³ä½ç½®
      if (!isMobile) {
        DOM.tooltip.style.left = '0';
        DOM.tooltip.style.right = '';
      } else {
        DOM.tooltip.style.left = '';
        DOM.tooltip.style.right = '';
      }
      DOM.tooltip.classList.add('visible');

      // è·å–ç›®æ ‡å’Œ tooltip çš„å®é™…å°ºå¯¸
      const target = event.target.closest('th, .matrix-cell, .gallery-item, .advanced-card');
      if (!target) {
        DOM.tooltip.classList.remove('visible');
        DOM.tooltip.style.visibility = '';
        return;
      }
      
      const targetRect = target.getBoundingClientRect();
      const tooltipRect = DOM.tooltip.getBoundingClientRect();
      
      // è®¡ç®—æœ€ç»ˆä½ç½®
      const pos = calcTooltipPosition(targetRect, tooltipRect);
      // ç§»åŠ¨ç«¯åªè®¾ç½® top, æ°´å¹³ä½ç½®ç”± CSS æ§åˆ¶
      if (!isMobile) {
        DOM.tooltip.style.left = pos.left + 'px';
      }
      DOM.tooltip.style.top = pos.top + 'px';
      DOM.tooltip.style.visibility = '';
    }

    function hideTooltip() {
      DOM.tooltip.classList.remove('visible');
    }

    // ========== å¼¹çª— ==========
    // ç”Ÿæˆå¼¹çª—ä¸­çš„ç»„ä»¶çƒ HTML
    function comboBallHtml(item, clickable) {
      const onclick = clickable ? ` data-modal="${safeName(item.name)}"` : '';
      return `<div class="combo-ball"${onclick}>
        ${imgHtml(item.img, item.name)}
        <span>${getName(item)}</span>
      </div>`;
    }

    function openModal(name) {
      // æŸ¥æ‰¾è¿›åŒ–çƒæˆ–åŸºç¡€çƒ
      const evo = evoByName.get(name) || ballByName.get(name) || ballById.get(name);
      if (!evo) return;

      DOM.modalImg.src = getImg(evo.img);
      // åªæ˜¾ç¤ºå½“å‰è¯­è¨€çš„åç§°
      DOM.modalTitle.textContent = getName(evo);
      DOM.modalTitleCn.textContent = '';
      DOM.modalEffect.textContent = getEffect(evo);

      // æ„å»ºå…ƒæ•°æ® HTML
      let metaHtml = '';
      const texts = (I18N && I18N[currentLang]) ? I18N[currentLang] : {
        attrDamageType: 'ä¼¤å®³ç±»å‹',
        attrStatusEffect: 'çŠ¶æ€æ•ˆæœ',
        attrAoeType: 'èŒƒå›´ç±»å‹',
        attrTags: 'ç‰¹æ€§æ ‡ç­¾'
      };
      
      // ä¼¤å®³ç±»å‹
      const damageHtml = buildDamageTypesHtml(evo);
      if (damageHtml) {
        metaHtml += `<div class="modal-meta-section">
          <div class="modal-meta-title">${texts.attrDamageType}</div>
          ${damageHtml}
        </div>`;
      }
      
      // çŠ¶æ€æ•ˆæœ
      const statusHtml = buildStatusEffectsHtml(evo);
      if (statusHtml) {
        metaHtml += `<div class="modal-meta-section">
          <div class="modal-meta-title">${texts.attrStatusEffect}</div>
          ${statusHtml}
        </div>`;
      }
      
      // AOEç±»å‹
      const aoeHtml = buildAoeHtml(evo);
      if (aoeHtml) {
        metaHtml += `<div class="modal-meta-section">
          <div class="modal-meta-title">${texts.attrAoeType}</div>
          ${aoeHtml}
        </div>`;
      }
      
      // æ ‡ç­¾
      const tagsHtml = buildTagsHtml(evo);
      if (tagsHtml) {
        metaHtml += `<div class="modal-meta-section">
          <div class="modal-meta-title">${texts.attrTags}</div>
          <div class="modal-tags">${evo.tags.map(tag => 
            `<span class="modal-tag" style="background-color: ${tag.color}">${getTagName(tag)}</span>`
          ).join('')}</div>
        </div>`;
      }
      
      DOM.modalMeta.innerHTML = metaHtml;
      DOM.modalMetaSection.style.display = metaHtml ? 'block' : 'none';

      let formulaHtml = '';
      
      if (evo.row && evo.col) {
        const ball1 = getBaseBall(evo.row);
        const ball2 = getBaseBall(evo.col);
        if (ball1) formulaHtml += comboBallHtml(ball1, false);
        formulaHtml += '<span class="combo-plus">+</span>';
        if (ball2) formulaHtml += comboBallHtml(ball2, false);
      }
      else if (evo.components) {
        evo.components.forEach((comp, i) => {
          const c = findComponent(comp);
          if (c) {
            const isEvo = evoByName.has(comp);
            formulaHtml += comboBallHtml(c, isEvo);
          }
          else {
            formulaHtml += `<div class="combo-ball"><span>${comp}</span></div>`;
          }
          if (i < evo.components.length - 1) {
            formulaHtml += '<span class="combo-plus">+</span>';
          }
        });
      }

      formulaHtml += '<span class="combo-equals">=</span>';
      formulaHtml += comboBallHtml(evo, false);

      DOM.modalFormula.innerHTML = formulaHtml;
      DOM.modalOverlay.classList.add('active');
    }

    function closeModal() {
      DOM.modalOverlay.classList.remove('active');
    }

    // ========== ç­›é€‰åŠŸèƒ½ ==========
    function applyFilter(filter) {
      currentFilter = filter;
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
      });
      
      // çŸ©é˜µè§†å›¾ - æ ¹æ®æ ‡ç­¾ç­›é€‰
      document.querySelectorAll('.matrix-cell:not(.empty)').forEach(cell => {
        const evo = getEvolution(cell.dataset.evo);
        const match = filter === 'all' || (evo && matchesFilter(evo, filter));
        cell.style.opacity = match ? '1' : '0.15';
      });
      
      // å›¾é‰´è§†å›¾
      document.querySelectorAll('.gallery-item').forEach(item => {
        const tags = item.dataset.tags || '';
        const match = filter === 'all' || tags.includes(filter);
        item.style.display = match ? 'block' : 'none';
      });
      
      // é«˜çº§/è¢«åŠ¨åŒºåŸŸ
      document.querySelectorAll('.advanced-card').forEach(card => {
        const tags = card.dataset.tags || '';
        const match = filter === 'all' || tags.includes(filter);
        card.style.display = match ? 'flex' : 'none';
      });
      
      // åˆ—è¡¨è§†å›¾ - æ ¹æ®å†…å®¹åŒ¹é…
      document.querySelectorAll('.list-card').forEach(card => {
        if (filter === 'all') {
          card.style.display = 'block';
          return;
        }
        // æ£€æŸ¥å¡ç‰‡ä¸­çš„è¿›åŒ–æ˜¯å¦åŒ¹é…
        const combos = card.querySelectorAll('.combo-item');
        let hasMatch = false;
        combos.forEach(combo => {
          const evo = getEvolution(combo.dataset.evo);
          if (evo && matchesFilter(evo, filter)) {
            hasMatch = true;
            combo.style.display = 'flex';
          } else {
            combo.style.display = 'none';
          }
        });
        card.style.display = hasMatch ? 'block' : 'none';
      });
    }

    // ========== æœç´¢ (å¸¦é˜²æŠ–) ==========
    function doSearch(query) {
      query = query.toLowerCase().trim();
      
      // å…ˆé‡ç½®ç­›é€‰
      if (query) {
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.filter === 'all');
        });
        currentFilter = 'all';
      }
      
      // çŸ©é˜µè§†å›¾
      document.querySelectorAll('.matrix-cell:not(.empty)').forEach(cell => {
        const evoName = cell.dataset.evo?.toLowerCase() || '';
        const evo = getEvolution(cell.dataset.evo);
        const nameCn = evo?.nameCn?.toLowerCase() || '';
        cell.style.opacity = (query && !evoName.includes(query) && !nameCn.includes(query)) ? '0.2' : '1';
      });

      // åˆ—è¡¨è§†å›¾
      document.querySelectorAll('.list-card').forEach(card => {
        const match = !query || card.textContent.toLowerCase().includes(query);
        card.style.display = match ? 'block' : 'none';
        // é‡ç½®combo-itemæ˜¾ç¤º
        card.querySelectorAll('.combo-item').forEach(combo => {
          combo.style.display = 'flex';
        });
      });

      // å›¾é‰´è§†å›¾
      document.querySelectorAll('.gallery-item').forEach(item => {
        const match = !query || item.textContent.toLowerCase().includes(query);
        item.style.display = match ? 'block' : 'none';
      });

      // é«˜çº§/è¢«åŠ¨åŒºåŸŸ
      document.querySelectorAll('.advanced-card').forEach(card => {
        const match = !query || card.textContent.toLowerCase().includes(query);
        card.style.display = match ? 'flex' : 'none';
      });
    }

    // é˜²æŠ–æœç´¢
    function handleSearch(query) {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => doSearch(query), 150);
    }

    // ========== è§†å›¾åˆ‡æ¢ ==========
    function switchView(view) {
      currentView = view;
      
      // æŒ‰éœ€æ¸²æŸ“: åªæœ‰é¦–æ¬¡åˆ‡æ¢åˆ°è¯¥è§†å›¾æ—¶æ‰æ¸²æŸ“
      renderView(view);
      
      document.querySelectorAll('.view-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.view === view);
      });

      document.querySelectorAll('.view-container').forEach(container => {
        container.classList.toggle('active', container.id === view + 'View');
      });

      // å›¾é‰´è§†å›¾å’Œç­–ç•¥è§†å›¾è‡ªå¸¦åŒºåŸŸ, å…¶ä»–è§†å›¾æ˜¾ç¤ºåº•éƒ¨åŒºåŸŸ
      const showAdvanced = view !== 'gallery' && view !== 'strategy';
      DOM.advancedSection.style.display = showAdvanced ? 'block' : 'none';
      DOM.passiveSection.style.display = showAdvanced ? 'block' : 'none';
      
      // åˆ‡æ¢è§†å›¾åé‡æ–°åº”ç”¨å½“å‰ç­›é€‰ (ç­–ç•¥è§†å›¾æœ‰è‡ªå·±çš„ç­›é€‰)
      if (view !== 'strategy') {
        applyFilter(currentFilter);
      }
    }

    // ========== æŒ‰éœ€æ¸²æŸ“æŒ‡å®šè§†å›¾ ==========
    function renderView(view) {
      if (viewRendered[view]) return;
      
      switch (view) {
        case 'matrix':
          renderMatrix();
          // çŸ©é˜µè§†å›¾éœ€è¦é«˜çº§è¿›åŒ–åŒº
          renderAdvancedSections();
          break;
        case 'list':
          renderList();
          break;
        case 'gallery':
          renderGallery();
          break;
        case 'strategy':
          renderStrategy();
          break;
      }
      
      viewRendered[view] = true;
    }

    // ========== æ¸²æŸ“å…¨éƒ¨ (ç”¨äºè¯­è¨€åˆ‡æ¢æ—¶å¼ºåˆ¶é‡æ–°æ¸²æŸ“) ==========
    function renderAll() {
      // é‡ç½®æ¸²æŸ“çŠ¶æ€
      viewRendered.matrix = false;
      viewRendered.list = false;
      viewRendered.gallery = false;
      viewRendered.strategy = false;
      
      // æ¸²æŸ“å½“å‰è§†å›¾
      renderView(currentView);
      
      // é«˜çº§è¿›åŒ–åŒºåœ¨éå›¾é‰´è§†å›¾æ—¶éƒ½éœ€è¦æ¸²æŸ“
      if (currentView !== 'gallery' && currentView !== 'strategy') {
        renderAdvancedSections();
      }
    }

    // ========== äº‹ä»¶å§”æ‰˜ ==========
    let currentHoverElement = null; // è¿½è¸ªå½“å‰æ‚¬åœçš„å…ƒç´ 

    // é€šç”¨çš„æ‚¬åœå¤„ç†å‡½æ•°
    function handleMouseOver(e, selector, getNameAndType) {
      const target = e.target.closest(selector);
      if (!target) return;
      
      // å¦‚æœæ˜¯åŒä¸€ä¸ªå…ƒç´ , ä¸é‡å¤å¤„ç†
      if (target === currentHoverElement) return;
      
      currentHoverElement = target;
      const { name, type } = getNameAndType(target);
      if (name) showTooltip(e, name, type);
    }

    function handleMouseOut(e, selector) {
      const target = e.target.closest(selector);
      if (!target) return;
      
      // æ£€æŸ¥ relatedTarget æ˜¯å¦ä»åœ¨åŒä¸€ä¸ªå…ƒç´ å†…
      const relatedTarget = e.relatedTarget;
      if (relatedTarget && target.contains(relatedTarget)) return;
      
      // çœŸæ­£ç¦»å¼€äº†å…ƒç´ 
      if (currentHoverElement === target) {
        currentHoverElement = null;
        hideTooltip();
      }
    }

    function setupEventDelegation() {
      // çŸ©é˜µè¡¨æ ¼: æ‚¬åœæç¤º
      DOM.matrixTable.addEventListener('mouseover', (e) => {
        handleMouseOver(e, '[data-type]', (el) => ({
          type: el.dataset.type,
          name: el.dataset.type === 'base' ? el.dataset.id : el.dataset.evo
        }));
      });
      
      DOM.matrixTable.addEventListener('mouseout', (e) => {
        handleMouseOut(e, '[data-type]');
      });

      // å›¾é‰´è§†å›¾: æ‚¬åœæç¤º
      const galleryContainer = document.getElementById('galleryView');
      galleryContainer.addEventListener('mouseover', (e) => {
        handleMouseOver(e, '.gallery-item', (el) => ({
          type: el.dataset.type,
          name: el.dataset.type === 'base' ? el.dataset.id : el.dataset.evo
        }));
      });
      
      galleryContainer.addEventListener('mouseout', (e) => {
        handleMouseOut(e, '.gallery-item');
      });

      // é«˜çº§/è¢«åŠ¨åŒºåŸŸ: æ‚¬åœæç¤º
      [DOM.advancedGrid, DOM.passiveGrid].forEach(grid => {
        grid.addEventListener('mouseover', (e) => {
          handleMouseOver(e, '.advanced-card', (el) => ({
            type: 'evo',
            name: el.dataset.evo
          }));
        });
        
        grid.addEventListener('mouseout', (e) => {
          handleMouseOut(e, '.advanced-card');
        });
      });

      // åˆ—è¡¨è§†å›¾: ç‚¹å‡»æ‰“å¼€å¼¹çª—
      DOM.listContainer.addEventListener('click', (e) => {
        const item = e.target.closest('.combo-item');
        if (item && item.dataset.evo) openModal(item.dataset.evo);
      });

      // å¼¹çª—å†…ç»„ä»¶ç‚¹å‡»
      DOM.modalFormula.addEventListener('click', (e) => {
        const ball = e.target.closest('[data-modal]');
        if (ball) openModal(ball.dataset.modal);
      });
    }

    // ========== åˆå§‹åŒ– ==========
    document.addEventListener('DOMContentLoaded', () => {
      buildIndexes();
      cacheDOM();
      updateUIText();
      renderView(currentView);
      setupEventDelegation();
      
      // è¯­è¨€åˆ‡æ¢æŒ‰é’®
      document.getElementById('langSwitch').addEventListener('click', switchLanguage);

      // è§†å›¾åˆ‡æ¢
      document.querySelectorAll('.view-tab').forEach(tab => {
        tab.addEventListener('click', () => switchView(tab.dataset.view));
      });

      // ç­›é€‰æŒ‰é’®
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          // æ¸…ç©ºæœç´¢æ¡†
          DOM.searchInput.value = '';
          applyFilter(btn.dataset.filter);
        });
      });

      // æœç´¢ (é˜²æŠ–)
      DOM.searchInput.addEventListener('input', (e) => handleSearch(e.target.value));

      // å¼¹çª—å…³é—­
      document.getElementById('modalClose').addEventListener('click', closeModal);
      DOM.modalOverlay.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeModal();
      });

      // ESC å…³é—­å¼¹çª—å’Œæç¤ºæ¡†
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeModal();
          hideTooltip();
        }
      });
    });
  </script>

</body>
</html>

